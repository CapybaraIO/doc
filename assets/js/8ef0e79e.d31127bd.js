"use strict";(self.webpackChunk_hirosystems_docs=self.webpackChunk_hirosystems_docs||[]).push([[6233],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>k});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=i,k=d["".concat(l,".").concat(m)]||d[m]||u[m]||r;return n?a.createElement(k,o(o({ref:t},p),{},{components:n})):a.createElement(k,o({ref:t},p))}));function k(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},27595:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var a=n(87462),i=(n(67294),n(3905));const r={id:"sending-tokens",title:"Sending tokens"},o=void 0,s={unversionedId:"tutorials/sending-tokens",id:"tutorials/sending-tokens",title:"Sending tokens",description:"Introduction",source:"@site/docs/tutorials/sending-tokens.md",sourceDirName:"tutorials",slug:"/tutorials/sending-tokens",permalink:"/doc/tutorials/sending-tokens",draft:!1,editUrl:"https://github.com/CapybaraIO/doc/tree/main/docs/tutorials/sending-tokens.md",tags:[],version:"current",lastUpdatedAt:1703206175,formattedLastUpdatedAt:"Dec 22, 2023",frontMatter:{id:"sending-tokens",title:"Sending tokens"},sidebar:"tutorials",previous:{title:"Managing accounts",permalink:"/doc/tutorials/managing-accounts"},next:{title:"Stacking using the Stacks CLI",permalink:"/doc/tutorials/stacking-using-cli"}},l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Installing libraries",id:"step-1-installing-libraries",level:2},{value:"Step 2: Specifying a sender",id:"step-2-specifying-a-sender",level:2},{value:"Step 3: Generating transaction",id:"step-3-generating-transaction",level:2},{value:"Estimating fees",id:"estimating-fees",level:3},{value:"Handling nonces",id:"handling-nonces",level:3},{value:"Step 4: Broadcasting transaction",id:"step-4-broadcasting-transaction",level:2},{value:"Serializing transactions",id:"serializing-transactions",level:3},{value:"Step 5: Checking completion",id:"step-5-checking-completion",level:2},{value:"Step 6: Confirming balance (optional)",id:"step-6-confirming-balance-optional",level:2}],p={toc:c},d="wrapper";function u(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"This tutorial walks you through the following steps:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Specifying a sender key"),(0,i.kt)("li",{parentName:"ul"},"Generating a token transfer transaction"),(0,i.kt)("li",{parentName:"ul"},"Broadcasting the transaction to the network"),(0,i.kt)("li",{parentName:"ul"},"Checking transaction completion"),(0,i.kt)("li",{parentName:"ul"},"Confirming updates account balances (optional)")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"This tutorial is NodeJS-specific. If you would like to understand how to initiate a token transfer by constructing and broadcasting transactions using a different language/framework, please ",(0,i.kt)("a",{parentName:"p",href:"https://docs.stacks.co/understand-stacks/transactions"},"review the transactions guide"),".")),(0,i.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("p",null,"You will need ",(0,i.kt)("a",{parentName:"p",href:"https://nodejs.org/en/download/"},"NodeJS")," ",(0,i.kt)("inlineCode",{parentName:"p"},"8.12.0")," or higher to complete this tutorial. You can verify your installation by opening up your terminal and run the following command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"node --version\n")),(0,i.kt)("p",null,"You should also complete the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.stacks.co/docs/understand-stacks/accounts"},"Accounts Tutorial"),". The following steps assume we have access to an existing Stacks 2.0 account."),(0,i.kt)("h2",{id:"step-1-installing-libraries"},"Step 1: Installing libraries"),(0,i.kt)("p",null,"First, install all the required libraries:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save @stacks/transactions bn.js @stacks/blockchain-api-client cross-fetch\n")),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"The API client is generated from the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/hirosystems/stacks-blockchain-api/blob/master/docs/openapi.yaml"},"OpenAPI specification")," (",(0,i.kt)("a",{parentName:"p",href:"https://github.com/OpenAPITools/openapi-generator"},"openapi-generator"),"). Many other languages and frameworks are be supported by the generator.")),(0,i.kt)("h2",{id:"step-2-specifying-a-sender"},"Step 2: Specifying a sender"),(0,i.kt)("p",null,"In order to build and sign transactions, you will need a Stacks private key. You can easily generate a new, random Stacks 2.0 sender key (see ",(0,i.kt)("a",{parentName:"p",href:"/tutorials/managing-accounts#step-2-generating-an-account"},'"Generating an account" from the previous tutorial'),")."),(0,i.kt)("p",null,"For this tutorial, we will use an existing Stacks account and instantiate the key object from a private key string:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"import fetch from 'cross-fetch';\nconst BN = require('bn.js');\nconst {\n  makeSTXTokenTransfer,\n  createStacksPrivateKey,\n  broadcastTransaction,\n  estimateTransfer,\n  getNonce,\n  privateKeyToString,\n} = require('@stacks/transactions');\nconst { StacksTestnet, StacksMainnet } = require('@stacks/network');\nconst { TransactionsApi, Configuration } = require('@stacks/blockchain-api-client');\n\nconst apiConfig = new Configuration({\n  fetchApi: fetch,\n  // for mainnet, replace `testnet` with `mainnet`\n  basePath: 'https://api.testnet.hiro.so',\n});\n\nconst key = 'edf9aee84d9b7abc145504dde6726c64f369d37ee34ded868fabd876c26570bc01';\nconst senderKey = createStacksPrivateKey(key);\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The code above also imports methods required for the next steps, including API configuration for the client library usage.")),(0,i.kt)("h2",{id:"step-3-generating-transaction"},"Step 3: Generating transaction"),(0,i.kt)("p",null,"To generate a token transfer transaction, we will be using the ",(0,i.kt)("inlineCode",{parentName:"p"},"makeSTXTokenTransfer()")," transaction builder function:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const recipient = 'SP3FGQ8Z7JY9BWYZ5WM53E0M9NK7WHJF0691NZ159';\n\n// amount of Stacks (STX) tokens to send (in micro-STX). 1,000,000 micro-STX are worth 1 Stacks (STX) token\nconst amount = new BN(1000000);\n\n// skip automatic fee estimation\nconst fee = new BN(2000);\n\n// skip automatic nonce lookup\nconst nonce = new BN(0);\n\n// override default setting to broadcast to the Testnet network\n// for mainnet, use `StacksMainnet()`\nconst network = new StacksTestnet();\n\nconst memo = 'hello world';\n\nconst txOptions = {\n  recipient,\n  amount,\n  fee,\n  nonce,\n  senderKey: privateKeyToString(senderKey),\n  network,\n  memo,\n};\n\n...\n\nconst transaction = await makeSTXTokenTransfer(txOptions);\n")),(0,i.kt)("p",null,"The generation method will need a few more pieces of information, as specified in the ",(0,i.kt)("inlineCode",{parentName:"p"},"txOptions")," object:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Parameter"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"),(0,i.kt)("th",{parentName:"tr",align:null},"Optional"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"recipientAddress")),(0,i.kt)("td",{parentName:"tr",align:null},"The recipient Stacks address in c32check format"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"td"},"No"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"amount")),(0,i.kt)("td",{parentName:"tr",align:null},"The amount of Stacks tokens to send denominated in microstacks"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("strong",{parentName:"td"},"No"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"fee")),(0,i.kt)("td",{parentName:"tr",align:null},"The fee that the sender is willing to pay for miners to process the transaction. Denominated in microstacks"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"nonce")),(0,i.kt)("td",{parentName:"tr",align:null},"A nonce is an integer that needs to be incremented by 1 for each sequential transaction from the same account. Nonces start at 0"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"senderKey")),(0,i.kt)("td",{parentName:"tr",align:null},"A private key object"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"network")),(0,i.kt)("td",{parentName:"tr",align:null},"Specifies whether the transaction is meant for Stacks Mainnet or Testnet"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"memo")),(0,i.kt)("td",{parentName:"tr",align:null},"A memo string to attach additional information to the transaction. This data is limited to 33 bytes"),(0,i.kt)("td",{parentName:"tr",align:null},"Yes")))),(0,i.kt)("h3",{id:"estimating-fees"},"Estimating fees"),(0,i.kt)("p",null,"If not specified, the transaction builder will automatically estimate the fee. Estimated fee rate is supplied by a Stacks node so network access is required."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Learn more about fees in the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.stacks.co/understand-stacks/network#fees"},"network guide"))),(0,i.kt)("p",null,"Another way to estimate the fee is to use the ",(0,i.kt)("inlineCode",{parentName:"p"},"estimateTransfer()")," function after you have constructed a transaction:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// get fee\nconst feeEstimate = estimateTransfer(transaction);\n\n// set fee manually\ntransaction.setFee(feeEstimate);\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"By setting a fee in the transaction builder function, the automatic fee estimation step will be skipped.")),(0,i.kt)("h3",{id:"handling-nonces"},"Handling nonces"),(0,i.kt)("p",null,"If not specified, the transaction builder will automatically lookup the latest nonce for the sender account. Automatic nonce handling also requires network access. The nonce should be tracked locally when creating multiple sequential transactions from the same account. A Stacks node only updates the nonce once a transaction has been mined."),(0,i.kt)("p",null,"The updated nonce for each account can be retrieved manually using the ",(0,i.kt)("inlineCode",{parentName:"p"},"getNonce()")," function:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const senderAddress = 'SJ2FYQ8Z7JY9BWYZ5WM53SKR6CK7WHJF0691NZ942';\n\nconst senderNonce = getNonce(senderAddress);\n")),(0,i.kt)("h2",{id:"step-4-broadcasting-transaction"},"Step 4: Broadcasting transaction"),(0,i.kt)("p",null,"Next, we will broadcast the transaction to the Testnet using the ",(0,i.kt)("inlineCode",{parentName:"p"},"network")," object we created earlier:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const broadcastResponse = await broadcastTransaction(transaction, network);\nconst txID = broadcastResponse.txid;\n")),(0,i.kt)("p",null,"As soon as the ",(0,i.kt)("inlineCode",{parentName:"p"},"broadcastTransaction")," is completed, a JSON object with the transaction ID (",(0,i.kt)("inlineCode",{parentName:"p"},"txid"),") is returned."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Keep in mind that the existence of a transaction ID does not mean the transaction has been successfully processed. Please review the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.stacks.co/understand-stacks/transactions#lifecycle"},"transaction lifecycle")," for more details.")),(0,i.kt)("h3",{id:"serializing-transactions"},"Serializing transactions"),(0,i.kt)("p",null,"In case you would like to inspect the raw serialized transaction, you can call the ",(0,i.kt)("inlineCode",{parentName:"p"},"serialize()")," method:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const serializedTx = transaction.serialize().toString('hex');\n")),(0,i.kt)("h2",{id:"step-5-checking-completion"},"Step 5: Checking completion"),(0,i.kt)("p",null,"With the transaction ID, we can check the status of the transaction. Every transaction needs to be confirmed by the network and will be ",(0,i.kt)("inlineCode",{parentName:"p"},"pending")," as soon as it is broadcasted."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"A transactions is completed once it is confirmed and the status changes to ",(0,i.kt)("inlineCode",{parentName:"p"},"success"),". Most transactions will be pending for several minutes before confirmed. You should implement polling in your app to refresh the status display.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const transactions = new TransactionsApi(apiConfig);\n\nconst txInfo = await transactions.getTransactionById({\n  txId,\n});\n\nconsole.log(txInfo);\n")),(0,i.kt)("p",null,"The API will respond with transaction details, including the ",(0,i.kt)("inlineCode",{parentName:"p"},"tx_status")," property:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"{\n  tx_id: '0x5f5318',\n  tx_type: 'token_transfer',\n  fee_rate: '180',\n  sender_address: 'STB44HYPYAT2BB2QE513NSP81HTMYWBJP02HPGK6',\n  sponsored: false,\n  post_condition_mode: 'deny',\n  tx_status: 'success',\n  block_hash: '0xe9b93259',\n  block_height: 2977,\n  burn_block_time: 1598915954,\n  burn_block_time_iso: '2020-08-31T23:19:14.000Z',\n  canonical: true,\n  tx_index: 1,\n  tx_result: { hex: '0x03', repr: 'true' },\n  token_transfer: {\n    recipient_address: 'ST9SW39M98MZXBGWSDVN228NW1NWENWCF321GWMK',\n    amount: '500000',\n    memo: '0x4661756'\n  },\n  events: [ { event_index: 0, event_type: 'stx_asset', asset: [ ... ] } ]\n}\n")),(0,i.kt)("p",null,"For all property formats and details, please review the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.hiro.so/api#operation/get_transaction_by_id"},"API reference"),"."),(0,i.kt)("h2",{id:"step-6-confirming-balance-optional"},"Step 6: Confirming balance (optional)"),(0,i.kt)("p",null,"Now that the token transfer is confirmed, we can verify the new account balance on the sender address by ",(0,i.kt)("a",{parentName:"p",href:"/tutorials/managing-accounts#step-5-getting-account-balances"},'following the "Getting account balances" steps from the previous tutorial'),"."))}u.isMDXComponent=!0}}]);