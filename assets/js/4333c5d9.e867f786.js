"use strict";(self.webpackChunk_hirosystems_docs=self.webpackChunk_hirosystems_docs||[]).push([[409],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>g});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},h="mdxType",k={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),h=c(n),p=o,g=h["".concat(l,".").concat(p)]||h[p]||k[p]||r;return n?a.createElement(g,s(s({ref:t},d),{},{components:n})):a.createElement(g,s({ref:t},d))}));function g(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,s=new Array(r);s[0]=p;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[h]="string"==typeof e?e:o,s[1]=i;for(var c=2;c<r;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},53256:(e,t,n)=>{n.d(t,{ZP:()=>i});var a=n(87462),o=(n(67294),n(3905));const r={toc:[]},s="wrapper";function i(e){let{components:t,...n}=e;return(0,o.kt)(s,(0,a.Z)({},r,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("a",{class:"block p-4 text-neutral-800 dark:text-neutral-100 hover:bg-neutral-100 hover:dark:bg-neutral-600 bg-neutral-200 rounded-lg dark:bg-neutral-700 mb-6 hover:no-underline hover:text-neutral-800 hover:dark:text-neutral-100 transition-colors",href:"https://docs.hiro.so/stacksjs-starters"},(0,o.kt)("span",{class:"i-radix-icons-lightning-bolt align-text-bottom text-lg"})," Bootstrap your project with ",(0,o.kt)("strong",null,"Stacks.js Starters"),", which come with Stacks Connect pre-installed ",(0,o.kt)("span",{class:"i-bi-globe2 align-text-bottom text-lg"})))}i.isMDXComponent=!0},37188:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>l,toc:()=>d});var a=n(87462),o=(n(67294),n(3905)),r=n(53256);const s={title:"Integrate Stacking Delegation"},i=void 0,l={unversionedId:"stacks.js/guides/how-to-integrate-stacking-delegation",id:"stacks.js/guides/how-to-integrate-stacking-delegation",title:"Integrate Stacking Delegation",description:"In this guide, you'll learn how to integrate the Stacking delegation flow by interacting with the respective smart contract, as well as reading data from the Stacks blockchain.",source:"@site/docs/stacks.js/guides/how-to-integrate-stacking-delegation.md",sourceDirName:"stacks.js/guides",slug:"/stacks.js/guides/how-to-integrate-stacking-delegation",permalink:"/stacks.js/guides/how-to-integrate-stacking-delegation",draft:!1,editUrl:"https://github.com/hirosystems/docs/tree/main/docs/stacks.js/guides/how-to-integrate-stacking-delegation.md",tags:[],version:"current",frontMatter:{title:"Integrate Stacking Delegation"}},c={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Step 1: Integrate libraries",id:"step-1-integrate-libraries",level:2},{value:"Step 2: Delegate STX tokens",id:"step-2-delegate-stx-tokens",level:2},{value:"Optional: Revoke delegation rights",id:"optional-revoke-delegation-rights",level:2},{value:"Step 3: Stack delegated STX tokens",id:"step-3-stack-delegated-stx-tokens",level:2},{value:"Step 4: Commit to Stacking",id:"step-4-commit-to-stacking",level:2}],h={toc:d},k="wrapper";function p(e){let{components:t,...n}=e;return(0,o.kt)(k,(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)(r.ZP,{mdxType:"StacksjsStartersNote"}),(0,o.kt)("p",null,"In this guide, you'll learn how to integrate the Stacking delegation flow by interacting with the respective smart contract, as well as reading data from the Stacks blockchain."),(0,o.kt)("p",null,"This guide highlights the following capabilities:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"As an account holder: delegate STX tokens"),(0,o.kt)("li",{parentName:"ul"},"As a delegator: Stack STX token on behalf of the account holder"),(0,o.kt)("li",{parentName:"ul"},"As a delegator: Commit to Stacking with all delegated STX tokens")),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"First, you'll need to understand the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.stacks.co/understand-stacks/stacking"},"Stacking delegation mechanism"),"."),(0,o.kt)("p",null,"You'll also need ",(0,o.kt)("a",{parentName:"p",href:"https://nodejs.org/en/download/"},"NodeJS")," ",(0,o.kt)("inlineCode",{parentName:"p"},"12.10.0")," or higher to complete this tutorial. You can verify your installation by opening up your terminal and run the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"node --version\n")),(0,o.kt)("p",null,"Finally, you need to have access to at least two accounts (STX account holder and delegator). For testing purposes on the testnet, you can use the CLI to generate them:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"stacks make_keychain -t > account.json\nstacks make_keychain -t > delegator.json\n")),(0,o.kt)("p",null,"You can use the faucet to obtain testnet STX tokens for the test account. Replace ",(0,o.kt)("inlineCode",{parentName:"p"},"<stxAddress>")," below with your address:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'curl -XPOST "https://stacks-node-api.testnet.stacks.co/extended/v1/faucets/stx?address=<stxAddress>&stacking=true"\n')),(0,o.kt)("h2",{id:"step-1-integrate-libraries"},"Step 1: Integrate libraries"),(0,o.kt)("p",null,"Install the stacking, network, transactions libraries, and bn.js for large number handling:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"npm install --save @stacks/stacking @stacks/network @stacks/transactions bn.js\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"See additional ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/blockstack/stacks.js/tree/master/packages/stacking"},"Stacking library reference"))),(0,o.kt)("h2",{id:"step-2-delegate-stx-tokens"},"Step 2: Delegate STX tokens"),(0,o.kt)("p",null,"To get started, delegate STX tokens as an account holder."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"import { getNonce } from '@stacks/transactions';\nimport { StacksTestnet, StacksMainnet } from '@stacks/network';\nimport { StackingClient } from '@stacks/stacking';\nimport BN from 'bn.js';\n\n// for mainnet: const network = new StacksMainnet();\nconst network = new StacksTestnet();\n\n// the stacker STX address\nconst address = 'ST3XKKN4RPV69NN1PHFDNX3TYKXT7XPC4N8KC1ARH';\n\nconst client = new StackingClient(address, network);\n\n// how much to stack, in microSTX\nconst amountMicroStx = new BN(100000000000);\n\n// STX address of the delegator\nconst delegateTo = 'ST2MCYPWTFMD2MGR5YY695EJG0G1R4J2BTJPRGM7H';\n\n// burn height at which the delegation relationship should be revoked (optional)\nconst untilBurnBlockHeight = 5000;\n\n// hash of bitcoin address that the delegator has to use to receive the pool's rewards (optional)\nconst poxAddress = undefined;\n\n// private key of the account holder for transaction signing\nconst privateKey = 'd48f215481c16cbe6426f8e557df9b78895661971d71735126545abddcd5377001';\n\nconst delegetateResponse = await client.delegateStx({\n  amountMicroStx,\n  delegateTo,\n  untilBurnBlockHeight, // optional\n  poxAddress, // optional\n  privateKey,\n});\n\n// {\n//   txid: '0xf6e9dbf6a26c1b73a14738606cb2232375d1b440246e6bbc14a45b3a66618481',\n// }\n")),(0,o.kt)("p",null,"This method calls the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.stacks.co/references/stacking-contract#delegate-stx"},(0,o.kt)("inlineCode",{parentName:"a"},"delegate-stx"))," method of the Stacking contract. Note, that the amount can be higher or lower than the current account balance. Delegation does not yet lock the STX tokens, users can still transfer them."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"To avoid handling private keys, it is recommended to use the ",(0,o.kt)("a",{parentName:"p",href:"https://www.hiro.so/wallet"},"Stacks Wallet")," to sign the delegation transaction")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Congratulations!")," With the completion of this step, you successfully learnt how to use the Stacking library to delegate STX tokens as an account holder."),(0,o.kt)("h2",{id:"optional-revoke-delegation-rights"},"Optional: Revoke delegation rights"),(0,o.kt)("p",null,"Delegators will be able to Stack STX tokens on the account holder's behalf until either the set burn height is reached or the account holder revokes the rights."),(0,o.kt)("p",null,"To revoke delegation rights, the account holder can call the ",(0,o.kt)("inlineCode",{parentName:"p"},"revokeDelegatestx")," method."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"const revokeResponse = await client.revokeDelegateStx(privateKey);\n\n// {\n//   txid: '0xf6e9dbf6a26c1b73a14738606cb2232375d1b440246e6bbc14a45b3a66618481',\n// }\n")),(0,o.kt)("p",null,"This method calls the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.stacks.co/references/stacking-contract#revoke-delegate-stx"},(0,o.kt)("inlineCode",{parentName:"a"},"revoke-delegate-stx"))," method of the Stacking contract."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"To avoid handling private keys, it is recommended to use the ",(0,o.kt)("a",{parentName:"p",href:"https://www.hiro.so/wallet"},"Stacks Wallet")," to sign the revoke transaction")),(0,o.kt)("h2",{id:"step-3-stack-delegated-stx-tokens"},"Step 3: Stack delegated STX tokens"),(0,o.kt)("p",null,"With an established delegation relationship, the delegator can stack STX tokens on behalf of the account holder. This happens usually in a different client app than the delegation."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// block height at which to stack\nconst burnBlockHeight = 2000;\n\n// the delegator initiates a different client\nconst delegatorAddress = 'ST22X605P0QX2BJC3NXEENXDPFCNJPHE02DTX5V74';\n\n// number cycles to stack\nconst cycles = 3;\n\n// delegator private key for transaction signing\nconst delegatorPrivateKey = 'd48f215481c16cbe6426f8e557df9b78895661971d71735126545abddcd5377001';\n\n// the BTC address for reward payouts; either to the delegator or to the BTC address set by the account holder\n// must start with \"1\" or \"3\". Native Segwit (starts with \"bc1\") is not supported\nconst delegatorBtcAddress = 'msiYwJCvXEzjgq6hDwD9ueBka6MTfN962Z';\n\n// if you call this method multiple times in the same block, you need to increase the nonce manually\nlet nonce = getNonce(delegatorAddress, network);\nnonce = nonce.add(new BN(1));\n\nconst delegatorClient = new StackingClient(delegatorAddress, network);\n\nconst delegetateStackResponses = await delegatorClient.delegateStackStx({\n  stacker: address,\n  amountMicroStx,\n  poxAddress: delegatorBtcAddress,\n  burnBlockHeight,\n  cycles,\n  privateKey: delegatorPrivateKey,\n  nonce, // optional\n});\n\n//   {\n//     txid: '0xf6e9dbf6a26c1b73a14738606cb2232375d1b440246e6bbc14a45b3a66618481',\n//   }\n")),(0,o.kt)("p",null,"This function calls the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.stacks.co/references/stacking-contract#delegate-stack-stx"},(0,o.kt)("inlineCode",{parentName:"a"},"delegate-stack-stx"))," method of the Stacking contract to lock up the STX token from the account holder."),(0,o.kt)("p",null,"The delegator must call this method multiple times (for all stackers), until enough tokens are locked up to participate in Stacking. This is the first part of delegated stacking for the delegator."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Reward slots are assigned based on the number of STX tokens locked up for a specific Bitcoin reward address")),(0,o.kt)("h2",{id:"step-4-commit-to-stacking"},"Step 4: Commit to Stacking"),(0,o.kt)("p",null,"As soon as pooling completes (minimum STX token threshold reached), the delegator needs to confirm participation for the next one or more cycles:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// reward cycle id to commit to\nconst rewardCycle = 12;\n\nconst delegetateCommitResponse = await delegatorClient.stackAggregationCommit({\n  poxAddress: delegatorBtcAddress, // this must be the delegator bitcoin address\n  rewardCycle,\n  privateKey: delegatorPrivateKey,\n});\n\n// {\n//   txid: '0xf6e9dbf6a26c1b73a14738606cb2232375d1b440246e6bbc14a45b3a66618481',\n// }\n")),(0,o.kt)("p",null,"This method calls the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.stacks.co/references/stacking-contract#stack-aggregation-commit"},(0,o.kt)("inlineCode",{parentName:"a"},"stack-aggregation-commit"))," function of the Stacking contract. This call also includes locked Stacks from previous cycles. This is the second part of delegated stacking for the delegator."),(0,o.kt)("p",null,"This method has to be called once for each reward cycle, even if all account holders have already locked their Stacks for several cycles in a row. If no new account holders are added to the pool, then this method call can be made even several cycles before the actual rewards cycle."),(0,o.kt)("p",null,"Locking delegated Stacks together with a aggregation commits can be done several times before the cycle starts as long as the minimum increment amount of locked Stacks is met."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Congratulations!")," With the completion of this step, you successfully learnt how to use the Stacking library to ..."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Stack STX token on behalf of an account holder"),(0,o.kt)("li",{parentName:"ul"},"Commit to Stacking with all delegated STX tokens")))}p.isMDXComponent=!0}}]);